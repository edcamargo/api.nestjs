name: Auto PR to Main

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  check-staging:
    name: Check Staging Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Wait for other workflows
        run: |
          echo "â³ Waiting 10 seconds for other workflows to complete..."
          sleep 10
          echo "âœ… Ready to proceed"

  create-pr:
    name: Create PR to Main
    needs: check-staging
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Debug workflow info
        run: |
          echo "ðŸ” Workflow Debug Info:"
          echo "- Event name: ${{ github.event_name }}"
          echo "- Ref: ${{ github.ref }}"
          echo "- Ref name: ${{ github.ref_name }}"
          echo "- SHA: ${{ github.sha }}"
          echo "- Actor: ${{ github.actor }}"
          echo "- Current branch: $(git branch --show-current)"
          echo "- Remote branches:"
          git branch -r

      - name: Check if PR already exists
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking for existing PR from develop to main..."
          PR_EXISTS=$(gh pr list --base main --head develop --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "âœ… PR exists: $PR_EXISTS"
          
          if [ "$PR_EXISTS" != "0" ]; then
            echo "âš ï¸ PR already exists, skipping creation"
            gh pr list --base main --head develop
          fi

      - name: Get version info
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')-${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create_pr
        if: steps.check_pr.outputs.pr_exists == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“ Creating PR from develop to main..."
          
          # Get latest commits
          COMMITS=$(git log origin/main..origin/develop --pretty=format:"- %s (%h)" --no-merges | head -10 || echo "No commits found")
          
          # Create a simple body file
          cat > pr_body.txt << 'EOF'
## ðŸš€ Production Release

This PR was automatically created after successful staging deployment.

### âœ… All Checks Passed
- âœ… Lint
- âœ… Unit Tests  
- âœ… E2E Tests
- âœ… Build
- âœ… Staging Deployment

### ðŸ“‹ Changes
EOF
          
          echo "" >> pr_body.txt
          echo "$COMMITS" >> pr_body.txt
          echo "" >> pr_body.txt
          
          cat >> pr_body.txt << 'EOF'

### âš ï¸ Important
- This will trigger a production deployment
- Review changes carefully before merging

---
*Automatically generated*
EOF
          
          # Create PR using gh CLI
          echo "ðŸš€ Creating PR..."
          gh pr create \
            --base main \
            --head develop \
            --title "ðŸŽ‰ Release v${{ steps.version.outputs.version }}" \
            --body-file pr_body.txt
          
          # Get PR number
          PR_NUMBER=$(gh pr list --base main --head develop --json number --jq '.[0].number')
          PR_URL=$(gh pr list --base main --head develop --json url --jq '.[0].url')
          
          echo "âœ… PR #$PR_NUMBER created successfully!"
          echo "ðŸ”— URL: $PR_URL"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          
      - name: PR Created Summary
        if: steps.check_pr.outputs.pr_exists == '0' && steps.create_pr.outputs.pr_number
        run: |
          echo "ðŸ“‹ PR Creation Summary:"
          echo "- PR Number: #${{ steps.create_pr.outputs.pr_number }}"
          echo "- PR URL: ${{ steps.create_pr.outputs.pr_url }}"
          echo "- Base: main"
          echo "- Head: develop"
          echo "- Version: v${{ steps.version.outputs.version }}"
          echo ""
          echo "âœ… Workflow completed successfully!"
