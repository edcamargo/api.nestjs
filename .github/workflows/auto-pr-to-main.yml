name: Auto PR to Main

on:
  push:
    branches:
      - develop
  workflow_dispatch: # Permite execuÃ§Ã£o manual para teste

jobs:
  check-staging:
    name: Wait for Staging Deployment
    runs-on: ubuntu-latest
    outputs:
      should_create_pr: ${{ steps.check.outputs.should_create }}
    
    steps:
      - name: Wait for other workflows to complete
        run: sleep 10
      
      - name: Check if should create PR
        id: check
        run: echo "should_create=true" >> $GITHUB_OUTPUT

  create-pr:
    name: Create PR to Main
    runs-on: ubuntu-latest
    needs: check-staging
    if: needs.check-staging.outputs.should_create_pr == 'true'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Debug workflow info
        run: |
          echo "ğŸ” Workflow Debug Info:"
          echo "- Event name: ${{ github.event_name }}"
          echo "- Ref: ${{ github.ref }}"
          echo "- Ref name: ${{ github.ref_name }}"
          echo "- SHA: ${{ github.sha }}"
          echo "- Actor: ${{ github.actor }}"
          echo "- Current branch: $(git branch --show-current)"
          echo "- Remote branches:"
          git branch -r

      - name: Check if PR already exists
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking for existing PR from develop to main..."
          PR_EXISTS=$(gh pr list --base main --head develop --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "âœ… PR exists: $PR_EXISTS"
          
          if [ "$PR_EXISTS" -gt 0 ]; then
            echo "âš ï¸ PR already exists, skipping creation"
            gh pr list --base main --head develop
          fi

      - name: Get version info
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')-${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Creating PR from develop to main..."
          
          # Get latest commits from develop
          echo "ğŸ“‹ Getting commit history..."
          COMMITS=$(git log origin/main..origin/develop --pretty=format:"- %s (%h)" --no-merges | head -10)
          
          echo "Commits to include:"
          echo "$COMMITS"
          
          # Create PR body using echo (more reliable)
          {
            echo "## ğŸš€ Production Release - v${{ steps.version.outputs.version }}"
            echo ""
            echo "This PR was automatically created after successful staging deployment."
            echo ""
            echo "### âœ… All Checks Passed"
            echo "- âœ… Lint"
            echo "- âœ… Unit Tests"
            echo "- âœ… E2E Tests"
            echo "- âœ… Build"
            echo "- âœ… Staging Deployment"
            echo ""
            echo "### ğŸ“‹ Changes"
            echo ""
            echo "\`\`\`"
            echo "$COMMITS"
            echo "\`\`\`"
            echo ""
            echo "### ğŸ¯ Deployment"
            echo "- **Environment**: Production"
            echo "- **Version**: v${{ steps.version.outputs.version }}"
            echo "- **Latest commit**: ${{ github.sha }}"
            echo "- **Author**: @${{ github.actor }}"
            echo ""
            echo "### âš ï¸ Important"
            echo "- This will trigger a production deployment"
            echo "- Review changes carefully before merging"
            echo "- Ensure all staging tests have passed"
            echo ""
            echo "---"
            echo "*This PR was automatically generated after successful develop deployment.*"
          } > pr_body.md

          echo "ğŸ“„ PR body created, content:"
          cat pr_body.md

          # Create the PR
          echo "ğŸš€ Creating PR..."
          gh pr create \
            --base main \
            --head develop \
            --title "ğŸ‰ Release v${{ steps.version.outputs.version }}" \
            --body-file pr_body.md \
            --label "automated-pr,release,production" || {
              echo "âŒ Failed to create PR"
              echo "Debug info:"
              gh auth status
              exit 1
            }
          
          echo "âœ… PR created successfully!"

      - name: Comment on PR
        if: steps.check_pr.outputs.pr_exists == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 2
          PR_NUMBER=$(gh pr list --base main --head develop --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr comment $PR_NUMBER --body "âœ… All staging checks passed! Ready for production deployment. 
          
          **Please review carefully before merging to production.**"
          fi
