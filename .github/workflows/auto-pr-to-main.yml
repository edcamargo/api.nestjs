name: Auto PR to Main

on:
  workflow_run:
    workflows: ["CD - Develop"]
    types:
      - completed
    branches:
      - develop

jobs:
  create-pr:
    name: Create PR to Main
    runs-on: ubuntu-latest
    # Only run if all checks passed on develop branch
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --base main --head develop --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "PR exists: $PR_EXISTS"

      - name: Get version info
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')-${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest commits from develop
          COMMITS=$(git log origin/main..origin/develop --pretty=format:"- %s (%h)" --no-merges | head -10)
          
          # Create PR body file
          cat > pr_body.md << 'EOF'
## ðŸš€ Production Release - vVERSION_PLACEHOLDER

This PR was automatically created after successful staging deployment.

### âœ… All Checks Passed
- âœ… Lint
- âœ… Unit Tests
- âœ… E2E Tests
- âœ… Build
- âœ… Staging Deployment

### ðŸ“‹ Changes

```
COMMITS_PLACEHOLDER
```

### ðŸŽ¯ Deployment
- **Environment**: Production
- **Version**: vVERSION_PLACEHOLDER
- **Latest commit**: COMMIT_SHA_PLACEHOLDER
- **Author**: @AUTHOR_PLACEHOLDER

### âš ï¸ Important
- This will trigger a production deployment
- Review changes carefully before merging
- Ensure all staging tests have passed

---
*This PR was automatically generated after successful develop deployment.*
EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${{ steps.version.outputs.version }}/g" pr_body.md
          sed -i "s|COMMITS_PLACEHOLDER|$COMMITS|g" pr_body.md
          sed -i "s/COMMIT_SHA_PLACEHOLDER/${{ github.event.workflow_run.head_sha }}/g" pr_body.md
          sed -i "s/AUTHOR_PLACEHOLDER/${{ github.event.sender.login }}/g" pr_body.md

          # Create the PR
          gh pr create \
            --base main \
            --head develop \
            --title "ðŸŽ‰ Release v${{ steps.version.outputs.version }}" \
            --body-file pr_body.md \
            --label "automated-pr,release,production"

      - name: Comment on PR
        if: steps.check_pr.outputs.pr_exists == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 2
          PR_NUMBER=$(gh pr list --base main --head develop --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr comment $PR_NUMBER --body "âœ… All staging checks passed! Ready for production deployment. 
          
          **Please review carefully before merging to production.**"
          fi
